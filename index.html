<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Multi-format Text Loader</title>
<!-- Include external libraries -->
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
</head>
<body>
<h2>Select a file to load:</h2>
<input type="file" id="fileInput" />
<br/><br/>
<textarea id="textInput" rows="20" cols="100" placeholder="Extracted text will appear here..."></textarea>

<script>
const fileInput = document.getElementById('fileInput');
const textInput = document.getElementById('textInput');

fileInput.addEventListener('change', () => {
  handleFiles(fileInput.files);
});

function handleFiles(files) {
  if (files.length === 0) return;
  const file = files[0];
  const filename = file.name.toLowerCase();

  // Clear previous content
  textInput.value = '';

  if (filename.endsWith('.txt')) {
    const reader = new FileReader();
    reader.onload = () => {
      textInput.value = reader.result;
    };
    reader.readAsText(file);

  } else if (filename.endsWith('.docx')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      mammoth.convertToHtml({buffer: e.target.result})
        .then(result => {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = result.value;
          textInput.value = tempDiv.innerText;
        })
        .catch(err => {
          alert('Error parsing DOCX: ' + err);
        });
    };
    reader.readAsArrayBuffer(file);

  } else if (filename.endsWith('.pdf')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const loadingTask = pdfjsLib.getDocument({data: e.target.result});
      loadingTask.promise.then(pdf => {
        let maxPages = Math.min(pdf.numPages, 10); // limit pages for performance
        let loadedPages = 0;
        let fullText = '';

        for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
          pdf.getPage(pageNum).then(page => {
            page.getTextContent().then(textContent => {
              const pageText = textContent.items.map(item => item.str).join(' ');
              fullText += pageText + '\n';
              loadedPages++;
              if (loadedPages === maxPages) {
                textInput.value = fullText;
              }
            });
          });
        }
      }).catch(err => {
        alert('Error loading PDF: ' + err);
      });
    };
    reader.readAsArrayBuffer(file);

  } else if (filename.endsWith('.fb2')) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(reader.result, "application/xml");
        // Extract text from all <body> elements
        const bodies = xmlDoc.getElementsByTagName('body');
        let fb2Text = '';
        for (let i = 0; i < bodies.length; i++) {
          fb2Text += bodies[i].textContent + '\n';
        }
        textInput.value = fb2Text;
      } catch (err) {
        alert('Error parsing FB2: ' + err);
      }
    };
    reader.readAsText(file);

  } else if (filename.endsWith('.epub')) {
    const reader = new FileReader();
    reader.onload = () => {
      const book = ePub(reader.result);
      book.loaded.navigation.then(() => {
        // Load the spine (chapters)
        book.loaded.spine.then(spine => {
          const spineItems = spine.spineItems;
          const chapterPromises = spineItems.map(item => item.load());

          Promise.all(chapterPromises).then(sections => {
            let fullText = '';
            sections.forEach(section => {
              fullText += section.contents + '\n';
            });
            textInput.value = fullText;
          }).catch(err => {
            alert('Error loading EPUB chapters: ' + err);
          });
        });
      }).catch(err => {
        alert('Error loading EPUB: ' + err);
      });
    };
    reader.readAsArrayBuffer(file);
  } else {
    alert('Unsupported file type.');
  }
}
</script>
</body>
</html>
