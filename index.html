<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Free Book Proofreader (English)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 30px auto; padding: 20px; }
    h1 { text-align: center; }
    #drop-zone { border: 2px dashed #aaa; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; background: #f9f9f9; }
    #drop-zone.highlight { border-color: #007bff; background: #e7f3ff; }
    textarea { width: 100%; height: 200px; margin: 10px 0; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px 5px; cursor: pointer; }
    #result { white-space: pre-wrap; border: 1px solid #ddd; padding: 15px; min-height: 200px; background: #fff; }
    .error { background: #ffe6e6; color: #c00; }
    .suggestion { background: #e6ffe6; }
    #status { color: #666; font-style: italic; }
  </style>
</head>
<body>
  <h1>Free English Book Proofreader</h1>
  <p>Upload .txt or paste your chapter (up to ~4000 words at a time). Powered by LanguageTool (free).</p>

  <div id="drop-zone">Drag & drop your .txt file here<br>or click to select</div>
  <input type="file" id="file-input" accept=".txt,.docx" style="display:none;">
  <textarea id="text-input" placeholder="Or paste your text here..."></textarea>

  <button id="check-btn">Check Grammar & Style</button>
  <button id="apply-btn" disabled>Apply Suggested Fixes</button>
  <button id="download-btn" disabled>Download Corrected Text</button>

  <div id="status"></div>
  <div id="result"></div>

  <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.432/pdf.min.mjs" type="module"></script>
<script type="module">
  // pdf.js Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ (Ð¾Ð±Ð¾Ð²'ÑÐ·ÐºÐ¾Ð²Ð¾ Ð´Ð»Ñ worker)
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.432/pdf.worker.min.mjs';

  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  const textInput = document.getElementById('text-input');
  const checkBtn = document.getElementById('check-btn');
  const applyBtn = document.getElementById('apply-btn');
  const downloadBtn = document.getElementById('download-btn');
  const resultDiv = document.getElementById('result');
  const status = document.getElementById('status');

  let originalText = '';
  let matches = [];
  let correctedText = '';

  // Drag & drop + click
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('highlight'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('highlight'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('highlight');
    handleFile(e.dataTransfer.files[0]);
  });

  async function handleFile(file) {
    if (!file) return;
    status.textContent = 'Reading file...';
    textInput.value = ''; // Ð¾Ñ‡Ð¸Ñ‰ÑƒÑ”Ð¼Ð¾ Ð¿Ð¾Ð»Ðµ

    try {
      if (file.name.endsWith('.txt')) {
        const text = await file.text();
        textInput.value = text;
        status.textContent = 'TXT loaded. Click "Check"';
      } 
      else if (file.name.endsWith('.docx')) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({arrayBuffer});
        textInput.value = result.value;
        status.textContent = 'DOCX loaded. Click "Check"';
      } 
      else if (file.name.toLowerCase().endsWith('.pdf')) {
        status.textContent = 'Extracting text from PDF... (may take time for large files)';
        
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        
        let fullText = '';
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n\n'; // Ð´Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ñ€Ð¾Ð·Ð´Ñ–Ð»ÑŒÐ½Ð¸Ðº Ð¼Ñ–Ð¶ ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÐ°Ð¼Ð¸
          status.textContent = `Extracted page ${pageNum} of ${pdf.numPages}...`;
        }
        
        textInput.value = fullText.trim();
        status.textContent = 'PDF text extracted! Click "Check"';
      } 
      else {
        status.textContent = 'Unsupported file type. Use .txt, .docx or .pdf';
      }
    } catch (err) {
      status.textContent = 'Error reading file: ' + err.message;
      console.error(err);
    }
  }

  checkBtn.addEventListener('click', async () => {
    const text = textInput.value.trim();
    if (!text) return alert('Paste or upload text first');
    status.textContent = 'Checking... (may take 5â€“60 sec for large text)';
    resultDiv.innerHTML = '';

    try {
      const formData = new FormData();
      formData.append('text', text);
      formData.append('language', 'en-US');
      formData.append('enabledOnly', 'false');

      const response = await fetch('https://api.languagetool.org/v2/check', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) throw new Error('API error: ' + response.status);
      const data = await response.json();

      matches = data.matches || [];
      originalText = text;
      correctedText = text;

      if (matches.length === 0) {
        resultDiv.innerHTML = '<p style="color:green">No errors found! ðŸŽ‰</p>';
      } else {
        let html = text.replace(/\n/g, '<br>');
        let offset = 0;
        matches.forEach(m => {
          const start = m.offset + offset;
          const end = start + m.length;
          const issue = (m.shortMessage || m.message).replace(/"/g, '&quot;');
          const repl = m.replacements[0]?.value || '';

          const errorPart = html.slice(start, end);
          html = html.slice(0, start) +
                 `<span class="error" title="${issue}">${errorPart}</span>` +
                 (repl ? `<span class="suggestion" title="Suggested: ${repl.replace(/"/g, '&quot;')}">${repl}</span>` : '') +
                 html.slice(end);

          if (repl) {
            const diff = repl.length - m.length;
            offset += diff;
            correctedText = correctedText.slice(0, m.offset + offset - repl.length + m.length) + repl + correctedText.slice(m.offset + offset);
          }
        });
        resultDiv.innerHTML = html;
      }

      applyBtn.disabled = matches.length === 0;
      downloadBtn.disabled = false;
      status.textContent = `Found ${matches.length} issues.`;
    } catch (err) {
      status.textContent = 'Error: ' + err.message + ' (try smaller text, wait 1 min, or check internet)';
      console.error(err);
    }
  });

  applyBtn.addEventListener('click', () => {
    textInput.value = correctedText;
    resultDiv.innerHTML = correctedText.replace(/\n/g, '<br>');
    status.textContent = 'Fixes applied!';
  });

  downloadBtn.addEventListener('click', () => {
    const content = correctedText || originalText;
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'corrected-manuscript.txt';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
  
</body>
</html>
