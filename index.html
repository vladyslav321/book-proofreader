<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Multi-format Text Loader with Progress</title>
<!-- Include external libraries -->
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<style>
  #status {
    margin-top: 10px;
    font-weight: bold;
  }
</style>
</head>
<body>
<h2>Select a file to load:</h2>
<input type="file" id="fileInput" />
<button id="checkBtn">Check</button>
<br/><br/>
<textarea id="textInput" rows="20" cols="100" placeholder="Extracted text will appear here..."></textarea>
<div id="status"></div>

<script>
const fileInput = document.getElementById('fileInput');
const checkBtn = document.getElementById('checkBtn');
const textInput = document.getElementById('textInput');
const statusDiv = document.getElementById('status');

checkBtn.addEventListener('click', () => {
  handleFiles(fileInput.files);
});

function showStatus(message) {
  statusDiv.innerText = message;
}

function handleFiles(files) {
  if (files.length === 0) {
    alert('Please select a file first.');
    return;
  }
  const file = files[0];
  const filename = file.name.toLowerCase();

  // Clear previous content and status
  textInput.value = '';
  showStatus('Processing...');

  if (filename.endsWith('.txt')) {
    const reader = new FileReader();
    reader.onload = () => {
      textInput.value = reader.result;
      showStatus('Done.');
    };
    reader.readAsText(file);

  } else if (filename.endsWith('.docx')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      mammoth.convertToHtml({buffer: e.target.result})
        .then(result => {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = result.value;
          textInput.value = tempDiv.innerText;
          showStatus('Done.');
        })
        .catch(err => {
          alert('Error parsing DOCX: ' + err);
          showStatus('Error.');
        });
    };
    reader.readAsArrayBuffer(file);

  } else if (filename.endsWith('.pdf')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const loadingTask = pdfjsLib.getDocument({data: e.target.result});
      loadingTask.promise.then(pdf => {
        let maxPages = Math.min(pdf.numPages, 10); // limit pages for performance
        let loadedPages = 0;
        let fullText = '';

        for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
          pdf.getPage(pageNum).then(page => {
            page.getTextContent().then(textContent => {
              const pageText = textContent.items.map(item => item.str).join(' ');
              fullText += pageText + '\n';
              loadedPages++;
              if (loadedPages === maxPages) {
                textInput.value = fullText;
                showStatus('Done.');
              }
            });
          });
        }
      }).catch(err => {
        alert('Error loading PDF: ' + err);
        showStatus('Error.');
      });
    };
    reader.readAsArrayBuffer(file);

  } else if (filename.endsWith('.fb2')) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(reader.result, "application/xml");
        const bodies = xmlDoc.getElementsByTagName('body');
        let fb2Text = '';
        for (let i = 0; i < bodies.length; i++) {
          fb2Text += bodies[i].textContent + '\n';
        }
        textInput.value = fb2Text;
        showStatus('Done.');
      } catch (err) {
        alert('Error parsing FB2: ' + err);
        showStatus('Error.');
      }
    };
    reader.readAsText(file);

  } else if (filename.endsWith('.epub')) {
    const reader = new FileReader();
    reader.onload = () => {
      const book = ePub(reader.result);
      book.loaded.navigation.then(() => {
        book.loaded.spine.then(spine => {
          const spineItems = spine.spineItems;
          const chapterPromises = spineItems.map(item => item.load());

          Promise.all(chapterPromises).then(sections => {
            let fullText = '';
            sections.forEach(section => {
              fullText += section.contents + '\n';
            });
            textInput.value = fullText;
            showStatus('Done.');
          }).catch(err => {
            alert('Error loading EPUB chapters: ' + err);
            showStatus('Error.');
          });
        });
      }).catch(err => {
        alert('Error loading EPUB: ' + err);
        showStatus('Error.');
      });
    };
    reader.readAsArrayBuffer(file);
  } else {
    alert('Unsupported file type.');
    showStatus('Unsupported file type.');
  }
}
</script>
</body>
</html>
